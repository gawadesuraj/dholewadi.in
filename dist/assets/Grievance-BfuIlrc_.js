import{o as C,b as c,s as u,j as e,P as _,C as b,B as j,y as l,Z as q,p as m}from"./index-C0LDelAR.js";import{r as p}from"./router-DLuhiZlq.js";import{I as o}from"./Input-CBgf1LBp.js";import"./vendor-BVxHPo8L.js";function L(){const[h,d]=p.useState([]),[r,t]=p.useState({name:"",phone:"",address:"",subject:"",description:"",grievance_type:""}),f=C({name:c().min(1,"Name is required").max(100,"Name too long"),phone:c().regex(/^[6-9]\d{9}$/,"Invalid mobile number (10 digits starting with 6-9)"),address:c().min(1,"Address is required").max(500,"Address too long"),subject:c().min(1,"Subject is required").max(200,"Subject too long"),description:c().min(1,"Description is required").max(1e3,"Description too long"),grievance_type:c().min(1,"Grievance type is required")}),[x,v]=p.useState(!1),y=["Water Supply Issues","Road and Infrastructure","Electricity Problems","Healthcare Services","Education Related","Sanitation Issues","Land Records","Certificate Issues","Tax and Revenue","Others"],N=async s=>{if(!s||s.trim().length!==10){l.error("Please enter a valid 10-digit mobile number to load past grievances");return}v(!0);const{data:a,error:n}=await u.from("grievances").select("*").eq("phone",s.trim()).order("created_at",{ascending:!1});n?(console.error(n),l.error("Error loading your previous grievances."),d([])):(d(a||[]),l.success("Past grievances loaded.")),v(!1)},w=async s=>{s.preventDefault();try{f.parse(r)}catch(i){i instanceof q&&i.errors.forEach(S=>l.error(S.message));return}const a={user_id:null,name:m.sanitize(r.name),phone:r.phone.trim(),email:null,address:m.sanitize(r.address),grievance_type:r.grievance_type,subject:m.sanitize(r.subject),description:m.sanitize(r.description),status:"new",created_at:new Date().toISOString()},{data:n,error:g}=await u.from("grievances").insert([a]).select().single();g?(l.error("Failed to submit grievance."),console.error(g)):(l.success(`Grievance submitted successfully! ID: ${n.id}`),t({name:"",phone:"",address:"",subject:"",description:"",grievance_type:""}),d(i=>[n,...i]))};return p.useEffect(()=>{if(!r.phone)return;const s=u.channel("realtime-grievances").on("postgres_changes",{event:"*",schema:"public",table:"grievances"},a=>{a.new&&a.new.phone===r.phone.trim()&&d(n=>n.find(i=>i.id===a.new.id)?n.map(i=>i.id===a.new.id?a.new:i):[a.new,...n])}).subscribe();return()=>{u.removeChannel(s)}},[r.phone]),e.jsxs("div",{children:[e.jsx(_,{title:"Citizen Grievance Portal",subtitle:"Submit your grievances directly without registration"}),e.jsxs("div",{className:"container py-12 grid lg:grid-cols-3 gap-8",children:[e.jsx("div",{className:"lg:col-span-2 space-y-6",children:e.jsx(b,{children:e.jsxs("div",{className:"p-6",children:[e.jsx("h2",{className:"text-xl font-semibold mb-4",children:"Grievance Registration"}),e.jsxs("form",{onSubmit:w,className:"space-y-6",children:[e.jsx(o,{label:"Name *",value:r.name,onChange:s=>t({...r,name:s.target.value}),required:!0}),e.jsx(o,{label:"Phone *",type:"tel",value:r.phone,onChange:s=>t({...r,phone:s.target.value}),placeholder:"10-digit mobile number",maxLength:"10",required:!0}),e.jsx(o,{label:"Address *",value:r.address,onChange:s=>t({...r,address:s.target.value}),required:!0}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium mb-2",children:"Grievance Type *"}),e.jsxs("select",{value:r.grievance_type,onChange:s=>t({...r,grievance_type:s.target.value}),required:!0,className:"w-full px-3 py-2 border rounded-md focus:ring-2 focus:ring-primary",children:[e.jsx("option",{value:"",children:"Select Type"}),y.map(s=>e.jsx("option",{value:s,children:s},s))]})]}),e.jsx(o,{label:"Subject *",value:r.subject,onChange:s=>t({...r,subject:s.target.value}),required:!0}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium mb-2",children:"Address *"}),e.jsx("textarea",{value:r.address,onChange:s=>t({...r,address:s.target.value}),rows:"3",className:"w-full px-3 py-2 border rounded-md focus:ring-2 focus:ring-primary",placeholder:"Enter your address...",required:!0})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium mb-2",children:"Description *"}),e.jsx("textarea",{value:r.description,onChange:s=>t({...r,description:s.target.value}),rows:"5",className:"w-full px-3 py-2 border rounded-md focus:ring-2 focus:ring-primary",placeholder:"Describe your grievance...",required:!0})]}),e.jsx(j,{type:"submit",className:"w-full",children:"Submit Grievance"})]})]})})}),e.jsx("div",{children:e.jsx(b,{children:e.jsxs("div",{className:"p-6",children:[e.jsx("h3",{className:"text-lg font-semibold mb-4",children:"Your Past Grievances"}),e.jsxs("div",{className:"mb-4",children:[e.jsx(o,{label:"Enter Phone Number to Load Past Grievances",type:"tel",value:r.phone,onChange:s=>t({...r,phone:s.target.value}),placeholder:"10-digit mobile number",maxLength:"10"}),e.jsx(j,{onClick:()=>N(r.phone),className:"w-full mt-2",disabled:x,children:x?"Loading...":"Load Past Grievances"})]}),h.length===0?e.jsx("p",{className:"text-gray-500 text-sm",children:'No previous grievances found. Enter your phone number and click "Load Past Grievances".'}):e.jsx("div",{className:"space-y-4",children:h.map(s=>e.jsxs("div",{className:"border rounded-lg p-4 bg-gray-50 hover:bg-gray-100 transition",children:[e.jsxs("div",{className:"flex justify-between items-center mb-1",children:[e.jsxs("p",{className:"font-semibold text-sm",children:["#",s.id," â€” ",s.subject]}),e.jsx("span",{className:`px-2 py-1 rounded-full text-xs ${s.status==="resolved"?"bg-green-100 text-green-700":s.status==="in_progress"?"bg-yellow-100 text-yellow-700":s.status==="rejected"?"bg-red-100 text-red-700":"bg-blue-100 text-blue-700"}`,children:s.status?s.status.replace("_"," "):"new"})]}),e.jsx("p",{className:"text-xs text-gray-500",children:new Date(s.created_at).toLocaleString()}),e.jsx("p",{className:"text-sm text-gray-600 mt-1 line-clamp-2",children:s.description})]},s.id))})]})})})]})]})}export{L as default};
